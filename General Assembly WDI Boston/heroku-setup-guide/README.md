[![General Assembly Logo](https://camo.githubusercontent.com/1a91b05b8f4d44b5bbfb83abac2b0996d8e26c92/687474703a2f2f692e696d6775722e636f6d2f6b6538555354712e706e67)](https://generalassemb.ly/education/web-development-immersive)

# Heroku Setup Guide

## Prerequisites

**Note: This guide assumes you have followed the installation instructions for the API template you are using, up to where the steps mention Heroku.**

## Objectives

By the end of this, developers should be able to:

- Create a heroku account
- Create a new heroku project
- Deploy a setup project to heroku

## Getting Set Up

Before you can begin deploying your applications to Heroku, there are some
things you'll need to do first.

**These steps should only be run the first time you are using Heroku. You do not need to make a new account for each project.**

1. [Create a Heroku account](https://www.heroku.com).
    You will be sent an activation email, so be sure to check your inbox so that
    you can activate your account.
1. Install the Heroku Command Line Tools:
   - On macOS, run `brew install heroku/brew/heroku`.
   - On Ubuntu/WSL, run `curl https://cli-assets.heroku.com/install.sh | sh`.
1. **Login to Heroku** by running `heroku auth:login` from the console and providing
    your Heroku credentials when asked. Once you log in, if you're prompted
    to add these credentials to your keychain, say yes. *You will not be able*
    *to see your password as you type*.

## Deploying to Heroku: Checklist

Now you're set up to use Heroku.

To deploy a new application to Heroku:

- [ ] [Create a New Heroku App](https://devcenter.heroku.com/articles/creating-apps)
- [ ] [Push `master` to Heroku](https://devcenter.heroku.com/articles/git#deploying-code)
- [ ] Setup Heroku's Database
- [ ] [Set Your Secrets](https://git.generalassemb.ly/ga-wdi-boston/rails-api-template/blob/master/rails-heroku-deployment-guide.md#setup-your-production-environment)
- [ ] [Check Your Work](https://git.generalassemb.ly/ga-wdi-boston/rails-api-template/blob/master/rails-heroku-deployment-guide.md#check-your-work)

Next, we will take a look at each of these steps in detail.

### Create a New Heroku App

Go to the root of your repo and run `heroku create`. This will create an awesome
_autogenerated_ name for your app, and add a new remote repository to your repo
 called _heroku_. View your remotes by typing `git remote -v`. You should see
something like:

```sh
heroku  git@heroku.com:agile-badlands-7658.git (fetch)
heroku  git@heroku.com:agile-badlands-7658.git (push)
origin  git@github.com:devloper/sei_project_2_backend.git (fetch)
origin  git@github.com: devloper/sei_project_2_backend.git (push)
```

### Create a New Heroku App

Go to the root of your repo and run `heroku create`. This will create an awesome
_autogenerated_ name for your app, and add a new remote repository to your repo
 called _heroku_. View your remotes by typing `git remote -v`. You should see
something like:

```sh
heroku  git@heroku.com:agile-badlands-7658.git (fetch)
heroku  git@heroku.com:agile-badlands-7658.git (push)
origin  git@github.com:devloper/sei_project_2_backend.git (fetch)
origin  git@github.com: devloper/sei_project_2_backend.git (push)
```

If you'd like to name your project, you can run `heroku create yourappname`. If you need to re-name it you can use `heroku apps:rename newappname`.

### Push `master` to Heroku

Heroku is really smart. When you `git push` to your Heroku app's `master` branch, it automagically updates your running application to have your new code. This is called using a deploy hook.

Only keep clean, working code on `master`. After you complete a feature, merge
it onto `master`. Push your updated `master` to Heroku, and the deploy will follow.

```sh
git checkout master
git merge my-feature # merge your working code
git push origin master # update GitHub
git push heroku master # update Heroku
```

### Update Heroku's Database

This depends on what API you are using. Follow steps in that API's deployment guide to setup the database.


### Set your Secrets

Your production environment needs to know certain things about your application that are not stored in your application code. We can configure _environment variables_ directly on our server to accomplish this.

In your Heroku app, we will be using the `heroku config` command. From the root of your local application in the console, run the following:

1. Configure CORS for your production app by setting the `CLIENT_ORIGIN` variable and point it to your client's root URL:
   - `heroku config:set CLIENT_ORIGIN=https://<github-username>.github.io`

2. Check the deployment guide you are using for your API to see if you need to add any other secrets to heroku.

_Note: You can also edit your app's config from the Heroku website. It's worth having a look at your app's dashboard on the Heroku website._

### Check Your Work

Ready to see your live application? Run:

```sh
heroku open
```

You'll probably see something like this:

![](https://cloud.githubusercontent.com/assets/388761/13259005/93c9fdf6-da23-11e5-9c90-19c59580944a.png)

That's normal, **unless** you have defined a root route. Try going to `/examples` to get some actual output (even if it's an empty array).

Heroku will automatically run your server and update your live application when you push updates to it or change config variables.

   - If you need to restart your server at any time, run `heroku restart`
   - If you need to view live server logs, run `heroku logs --tail`. Quit with `ctrl-c`

## Troubleshooting

If your Heroku deployment isn't working as expected, review these steps above carefully.

Below are some common scenarios for broken apps and how to get them up and running again:

-  You can't fix what you can't see. View your production server logs with `heroku logs --tail`
- Sometimes you just need to kick over your running application. Restart it with `heroku restart`, and watch your server logs for errors as you access resources.
- Make sure you are looking at the correct app: `heroku open`
- Make sure you pushed your _master_ branch to Heroku's _master_ branch (and you didn't try to push a _feature_ branch instead)
- Double check your config vars using `heroku config`. Look for mismatched or missing values.
- Remember, **the production database is entirely separate from your development database**. The DB is a very common source of application errors. Make sure you've created the data you expect to see, and have run any migrations if relevant.

## Heroku Command Reference

A full list of Heroku commands can be accessed by running `heroku --help`; below
are some of the more common ones.

|                Commands                |                                                 Behavior                                                 |
| -------------------------------------- | -------------------------------------------------------------------------------------------------------- |
|             `heroku logs [--tail]`              |                                   Running just `heroku logs` will show you the server logs from your deployed API. The `--tail` flag is optional.                        |
|            `heroku run ...`            |                                    Run a program from within Heroku. Examples (`heroku run rails console`, `heroku run rails db:migrate`).                                     |
|            `heroku config`             |                           Environmental variables in your current Heroku app.                            |
|            `heroku config:set CLIENT_ORIGIN=https://yourgithubname.github.io`            |                                    Set CLIENT_ORIGIN.                                     |
|            `heroku apps:rename newname`            |                                    Rename Heroku app name (entirely optional).                                     |
|            `heroku restart`            |                                    Restart the Heroku app, make sure you do this after changing your API.                                     |
|            `heroku open`            |                                    Open your Heroku app in default browser.                                     |
|            `heroku --help`            |                                    Displays a Heroku CLI usage summary.                                     |

## WARNING: Ephemeral Filesystem

One serious limitation of Heroku is that it provides an "ephemeral filesystem";
in other words, if you try to save a new file inside the repo (e.g. an uploaded
image file), it will disappear when your app is restarted or redeployed.

As an example, try running the following commands:

```sh
heroku run bash
touch happy.txt; echo 'is happy' > happy.txt
cat happy.txt
```

Then, hit Ctrl-D to get out of Heroku bash shell. If you re-open the shell and
run `ls -l`, `happy.txt` will be missing!

The typical workaround is to save files in cloud storage such as [Amazon
S3](https://aws.amazon.com/s3/); more on this in the near future.

![](https://www.thehinzadventures.com/wp-content/uploads/2015/03/54843046.jpg)

## Additional Resources

- [Heroku Command Line](https://devcenter.heroku.com/categories/command-line)

## [License](LICENSE)

1. All content is licensed under a CC­BY­NC­SA 4.0 license.
1. All software code is licensed under GNU GPLv3. For commercial use or
    alternative licensing, please contact legal@ga.co.
